## План: Веб-генератор IFC фундаментных болтов

**TL;DR:** Создать одностраничное веб-приложение с использованием ванильного HTML/CSS/JavaScript и Pyodide для запуска Python. Приложение будет работать полностью в браузере, не требуя серверной части. Архитектура разделена на три основных слоя: UI (HTML/CSS/JS), Python логика (Pyodide), и 3D визуализация (Three.js). Разработка проходит в два этапа: инициализация IFC типов (один раз при загрузке) и генерация инстансов болтов (для каждого пользовательского ввода).

---

### **1. Архитектура приложения**

```
┌─────────────────────────────────────────────────────────┐
│         HTML Interface Layer (интерфейс)                │
│  - Форма ввода параметров                              │
│  - 3D Viewport для Three.js                            │
│  - Панель свойств элементов                            │
└────────────────┬──────────────────────────────────────────┘
                 ↓ JSON параметры
┌─────────────────────────────────────────────────────────┐
│    JavaScript Orchestration (управление логикой)        │
│  - Валидация входных данных                            │
│  - Управление состоянием приложения                    │
│  - Интеграция с Pyodide                                │
│  - Конвертация IFC в Three.js меш                      │
└────────────────┬──────────────────────────────────────────┘
                 ↓ Вызов Python функций
┌─────────────────────────────────────────────────────────┐
│    Python Logic Layer (Pyodide)                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │ IFC Model Generator                              │  │
│  │  - Инициализация типов (один раз)               │  │
│  │  - Создание типов болтов                        │  │
│  │  - Генерация инстансов                          │  │
│  │  - Управление Property Sets                     │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │ GOST Data Provider                               │  │
│  │  - Справочные параметры ГОСТ                    │  │
│  │  - Валидация по стандартам                      │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────┬──────────────────────────────────────────┘
                 ↓ IFC файл
┌─────────────────────────────────────────────────────────┐
│    Output: IFC4.0.2.1 файл + Mesh для 3D                 │
└─────────────────────────────────────────────────────────┘
```

---

### **2. Структура проекта**

```
anchor-bolt-generator/
├── index.html                  # Главная страница с UI
├── style.css                   # Стили интерфейса
├── main.js                     # Главная логика браузера
├── python/
│   ├── requirements.txt        # Зависимости Python
│   ├── main.py                 # Точка входа Pyodide
│   ├── ifc_generator.py        # Генератор IFC моделей
│   ├── gost_data.py           # Справочные данные ГОСТ
│   └── geometry_builder.py     # Построение геометрии
├── assets/
│   ├── three.min.js           # Библиотека Three.js
│   └── icons/                 # Иконки UI
├── dist/                      # Собранное приложение (Flet output)
└── README.md                  # Документация
```

---

### **3. Детальное описание компонентов**

#### **3.1 HTML интерфейс** (index.html)
- **Форма ввода** (левая колонка):
  - Выбор типа болта (1.1, 1.2, 2.1, 5)
  - Выбор диаметра резьбы (от 12 до 100 мм)
  - Выбор длины болта
  - Выбор марки стали (по ГОСТ 19281-2014)
  - Опции для гаек и шайб (количество, положение)
  - Кнопка "Создать IFC"

- **3D Viewport** (центральная часть):
  - Canvas для Three.js (размер адаптивный)
  - Статус загрузки Python/IfcOpenShell
  - Индикатор прогресса генерации

- **Панель свойств** (правая колонка):
  - Вкладка "Сборка" — свойства всего болта
  - Вкладка "Выбранный элемент" — свойства при клике на элемент
  - Экспорт/скачивание IFC файла

#### **3.2 JavaScript логика** (main.js)
**Ответственность:**
- Инициализация Pyodide и загрузка Python интерпретатора
- Управление формой и валидацией
- Event listeners для 3D камеры (вращение, зум)
- Click detection для выделения элементов в 3D
- Конвертация IFC объектов в Three.js меши
- Управление загрузкой/скачиванием файлов

**Основные функции:**
- `initializePyodide()` — инициализация окружения
- `generateBolt(params)` — вызов Python для создания болта
- `convertIFC2Mesh(ifcData)` — конвертация IFC в Three.js меш
- `setupThreeJS()` — инициализация 3D сцены
- `downloadIFC(data)` — скачивание файла

#### **3.3 Python модуль: IFC Generator** (ifc_generator.py)

**Двухэтапная архитектура:**

**Этап 1: Инициализация типов (один раз при загрузке)**
- Создание `IfcMechanicalFastenerType` для шпильки (ElementType "STUD")
- Создание `IfcMechanicalFastenerType` для гаек (ElementType "NUT")
- Создание `IfcMechanicalFastenerType` для шайб (ElementType "WASHER")
- Создание `IfcMechanicalFastenerType` для сборки (PredefinedType "ANCHORBOLT")
- Определение всех Property Sets (Pset_MechanicalFastenerCommon и др.)
- Привязка материалов к типам

**Этап 2: Генерация инстансов (для каждого параметра)**
- Создание инстансов `IfcMechanicalFastener` для шпильки, гаек, шайб
- Размещение инстансов в пространстве через `IfcObjectPlacement`
- Связь инстансов с типами через `IfcRelDefinesByType`
- Агрегация компонентов через `IfcRelAggregates`
- Связь элементов через `IfcRelConnectsElements`

**Функции:**
- `class BoltTypesFactory` — создание и управление типами
- `class BoltInstanceGenerator` — создание инстансов
- `create_swept_disk_solid(...)` — геометрия шпильки
- `create_nut_geometry(...)` — геометрия гайки
- `create_washer_geometry(...)` — геометрия шайбы
- `setup_property_sets(...)` — управление свойствами
- `export_ifc_file(...)` — экспорт в .ifc файл

#### **3.4 Python модуль: GOST Data** (gost_data.py)

**Справочные данные:**
- Доступные типы болтов и исполнения
- Номера позиций шпилек (ГОСТ 24379.1-2012):
  - Тип 1.1 → позиция 1
  - Тип 1.2 → позиция 2
  - Тип 2.1 → позиция 3
  - Тип 5 → позиция 7
- Параметры диаметров (M12, M16, M20, M24, M30, M36, M42, M48, M56, M64, M72, M80, M90, M100)
- Стандартные длины болтов по типам
- Марки стали (ВСт3пс2, 09Г2С, 10Г2, и т.д.)
- Параметры гаек (высота, размер под ключ)
- Параметры шайб (внешний диаметр, толщина)

**Класс:**
- `class GOSTBoltParameters` — управление справочными данными
- `validate_parameters(type, diameter, length, ...)` — валидация

#### **3.5 Python модуль: Geometry Builder** (geometry_builder.py)

**Построение геометрии в IFC:**

**Для шпильки (IfcSweptDiskSolid):**
- Осевая линия как `IfcCompositeCurve` из:
  - `IfcLine` (нижний участок)
  - `IfcCircularArc` или `IfcCircularArcSegment3D` (для изогнутых болтов)
  - `IfcLine` (верхний участок)
- Радиус диска = диаметр резьбы / 2

**Для гаек и шайб (IfcExtrudedAreaSolid):**
- Профиль `IfcArbitraryProfileDefWithVoids`:
  - Внешний контур: `IfcPolyline` (6 вершин для гайки) или `IfcCircleProfileDef`
  - Внутреннее отверстие: `IfcCircleProfileDef`

---

### **4. Поток данных и взаимодействие компонентов**

```
Пользователь вводит параметры
         ↓
[JavaScript] main.js валидирует данные
         ↓
[JavaScript] Вызывает py.generate_bolt(params)
         ↓
[Python] gost_data.py проверяет соответствие ГОСТ
         ↓
[Python] geometry_builder.py строит геометрию
         ↓
[Python] ifc_generator.py создает IFC объекты
         ↓
[Python] Возвращает IFC данные и метаинформацию
         ↓
[JavaScript] Конвертирует IFC → Three.js меш
         ↓
[JavaScript] Рендерит 3D модель
         ↓
[JavaScript] Обновляет панель свойств
         ↓
[Пользователь] нажимает "Скачать IFC"
         ↓
[JavaScript] Скачивает .ifc файл
```

---

### **5. Ключевые решения архитектуры**

| Решение | Преимущество |
|---------|-------------|
| **Веб-приложение в браузере** | Не требует установки, работает везде где есть браузер |
| **Pyodide для Python** | Выполнение Python в браузере без сервера |
| **Типо-инстансный подход IFC** | Единая точка определения типов, снижение объема данных |
| **Двухэтапная инициализация** | Типы создаются один раз, инстансы быстро генерируются |
| **Three.js для визуализации** | Встроенная поддержка в браузере, не требует плагинов |
| **Ванильный JavaScript** | Отсутствие зависимостей от фреймворков |

---

### **6. Технологический стек и версии**

| Компонент | Версия | Назначение |
|-----------|--------|-----------|
| Python | 3.11+ | Логика IFC |
| IfcOpenShell | 0.7.0+ | Работа с IFC форматом |
| Pyodide | 0.23.0+ | Запуск Python в браузере |
| Three.js | r150+ | 3D визуализация |
| IFC Scheme | IFC4.0.2.1 / IFC4 ADD2 TC1 | Стандарт для России |

---

### **7. Этапы разработки**

| # | Компонент | Описание | Зависимости |
|---|-----------|---------|------------|
| 1 | Базовая структура | index.html, style.css, main.js | — |
| 2 | Инициализация Pyodide | Загрузка Python интерпретатора | — |
| 3 | GOST справочники | Создать gost_data.py с параметрами | Этап 2 |
| 4 | Geometry Builder | Реализовать geometry_builder.py | Этап 2 |
| 5 | IFC типы | Реализовать создание типов в ifc_generator.py | Этап 3, 4 |
| 6 | IFC инстансы | Реализовать генерацию инстансов | Этап 5 |
| 7 | Three.js интеграция | Конвертация IFC → меш, рендеринг | Этап 1, 6 |
| 8 | Интерактивность | Click detection, выделение элементов | Этап 7 |
| 9 | UI форма | Полная форма ввода с валидацией | Этап 3, 6 |
| 10 | Экспорт IFC | Скачивание .ifc файла | Этап 6 |
| 11 | Тестирование | Валидация IFC, проверка стандартов | Все этапы |

---

### **8. Требования к функциям Python**

**main.py** (точка входа):
```
def initialize_types()
  → Создает все типы один раз

def generate_bolt(params: dict)
  params: { type, diameter, length, material, position_nuts, position_washers }
  → Создает инстансы болта
  → Возвращает IFC данные + метаинформацию для 3D
```

**ifc_generator.py**:
```
class BoltTypesFactory:
  - create_stud_type()
  - create_nut_type()
  - create_washer_type()
  - create_assembly_type()
  - add_property_sets()

class BoltInstanceGenerator:
  - create_stud_instance(type, position)
  - create_nut_instances(type, positions)
  - create_washer_instances(type, positions)
  - create_assembly_instance()
  - link_instances_to_types()
  - export_ifc()
```

---

### **9. Валидация и проверки**

- Проверка диаметра резьбы в диапазоне ГОСТ
- Проверка длины болта относительно диаметра
- Проверка совместимости типа болта и исполнения
- Проверка наличия гаек/шайб для типа
- Валидация IFC структуры перед экспортом

---

### **10. Производительность и ограничения браузера**

- Размер IfcOpenShell в Pyodide: ~50-80 MB (загружается один раз)
- Генерация одного болта: ~100-500 мс
- Рендеринг 3D в Three.js: реальное время
- Максимальный размер IFC файла: ~10 MB (типично ~100-500 KB)
