## Детальный план создания одностраничного веб-приложения для генерации IFC-модели фундаментных болтов по ГОСТ 24379.1-2012

### 1. Архитектура сборки — иерархия типов и инстансов IFC

Проект реализует строгую типо-инстансную модель согласно IFC4. Это гарантирует компактность файла, лёгкую модификацию параметров и соответствие стандарту.

**Диаграмма иерархии (текстовое описание):**

```
                                  ┌─────────────────────────────────────────────────┐
                                  │  IfcProject, IfcSite, IfcBuilding, IfcBuildingStorey  │
                                  └─────────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                              ┌─────────────────────────────┐
                                              │   IfcMechanicalFastenerType  │  << Типы >>
                                              └─────────────────────────────┘
                                                              │
                      ┌───────────────────────────────────────┼───────────────────────────────────────┐
                      ▼                                       ▼                                       ▼
        ┌─────────────────────────┐             ┌─────────────────────────┐             ┌─────────────────────────┐
        │  StudType               │             │  NutType                │             │  WasherType              │
        │  (ElementType="STUD")   │             │  (ElementType="NUT")    │             │  (ElementType="WASHER")  │
        │  - Geometry: SweptDisk  │             │  - Geometry: Extruded   │             │  - Geometry: Extruded    │
        │  - PSets: Common        │             │  - PSets: Common        │             │  - PSets: Common         │
        │  - Material: 09Г2С      │             │  - Material: 09Г2С      │             │  - Material: 09Г2С       │
        └───────────┬─────────────┘             └───────────┬─────────────┘             └───────────┬─────────────┘
                    │ IsTypedBy                              │ IsTypedBy                              │ IsTypedBy
                    ▼                                        ▼                                        ▼
        ┌─────────────────────────┐             ┌─────────────────────────┐             ┌─────────────────────────┐
        │  IfcMechanicalFastener  │             │  IfcMechanicalFastener  │             │  IfcMechanicalFastener  │
        │  (Stud instance)        │             │  (Nut instance)         │             │  (Washer instance)      │
        │  - Placement: pos       │             │  - Placement: pos       │             │  - Placement: pos       │
        └───────────┬─────────────┘             └───────────┬─────────────┘             └───────────┬─────────────┘
                    │                                       │                                       │
                    └───────────────────────────────────────┼───────────────────────────────────────┘
                                                            │ Aggregates
                                                            ▼
                                         ┌─────────────────────────────────────┐
                                         │  IfcMechanicalFastener (Assembly)   │
                                         │  PredefinedType="ANCHORBOLT"        │
                                         │  - PSets: Manufacturer, AnchorBolt  │
                                         │  - Aggregates: all components       │
                                         └─────────────────────────────────────┘
                                                            │
                                         Connects (IfcRelConnectsElements) между Stud и Nut/Washer
```

**Пояснения:**
- Все физические элементы (шпилька, гайки, шайбы, сборка) являются экземплярами класса `IfcMechanicalFastener`.
- Каждый экземпляр ссылается на соответствующий тип через отношение `IfcRelDefinesByType`.
- Типы содержат полную геометрию, материалы и Property Sets, экземпляры наследуют их и добавляют только размещение.
- Сборка агрегирует все компоненты через `IfcRelAggregates` и служит точкой входа для всей конструкции.
- Дополнительно создаются связи `IfcRelConnectsElements` для явного описания соединений (шпилька с каждой гайкой/шайбой).

### 2. Структура проекта — дерево файлов и папок

```
/
├── index.html                 # Основная страница приложения
├── css/
│   └── style.css              # Стили интерфейса (панель управления, канвас)
├── js/
│   ├── main.js                # Инициализация Pyodide, загрузка Python-модулей, обработка UI-событий
│   ├── viewer.js              # Трёхмерная сцена Three.js: камера, освещение, рендеринг, raycast-выбор
│   └── ifcBridge.js           # Коммуникация с Python: передача параметров, приём мешей и свойств
├── py/
│   ├── main.py                # Точка входа Python: настройка окружения, инициализация типов (один раз), фабрика инстансов
│   ├── ifc_generator.py       # Генерация полного IFC-файла в виде строки или объекта ifc_file
│   ├── geometry_utils.py      # Функции построения кривых (IfcCompositeCurve), профилей (IfcArbitraryProfileDefWithVoids)
│   ├── type_factory.py        # Создание и кэширование типов (IfcMechanicalFastenerType) с геометрией и PSets
│   ├── instance_factory.py    # Создание инстансов с размещением и связями с типами
│   ├── pset_manager.py        # Заполнение Property Sets на типах (Pset_...Common, Manufacturer и т.д.)
│   ├── material_manager.py    # Создание IfcMaterial и связывание с типами
│   └── gost_data.py           # Справочники по ГОСТ 24379.1-2012 (диаметры, длины, размеры гаек/шайб)
├── assets/
│   └── (иконки, шрифты и пр.)
└── README.md
```

### 3. Спецификация IfcMechanicalFastenerType — таблица атрибутов типов и их назначение

| Тип элемента | PredefinedType | ElementType (IfcLabel) | Геометрия | PSets (назначаемые) |
|--------------|----------------|-------------------------|-----------|----------------------|
| **Шпилька**  | USERDEFINED    | "STUD"                  | `IfcSweptDiskSolid` на основе `IfcCompositeCurve` | `Pset_MechanicalFastenerCommon` (NominalDiameter, NominalLength) |
| **Гайка**    | USERDEFINED    | "NUT"                   | `IfcExtrudedAreaSolid` с профилем `IfcArbitraryProfileDefWithVoids` (шестиугольник + отверстие) | `Pset_MechanicalFastenerCommon` (NominalDiameter) |
| **Шайба**    | USERDEFINED    | "WASHER"                | `IfcExtrudedAreaSolid` с профилем `IfcArbitraryProfileDefWithVoids` (круг + отверстие) | `Pset_MechanicalFastenerCommon` (NominalDiameter) |
| **Сборка**   | ANCHORBOLT     | (не используется)       | отсутствует (представление не задаётся) | `Pset_ElementComponentCommon`, `Pset_ManufacturerTypeInformation`, `Pset_MechanicalFastenerAnchorBolt` |

**Примечание:** Все типы наследуют материал через `IfcRelAssociatesMaterial`. Материал задаётся один раз на тип.

### 4. Создание типов элементов (один раз при инициализации приложения)

#### 4.1. Построение осевой линии для шпильки

Осевая линия строится как `IfcCompositeCurve` из следующих сегментов (в зависимости от типа болта):

- **Для типа 1 (исполнения 1, 2) с изгибом:**
  1. Нижний прямой участок (от закладного конца до начала изгиба) – `IfcLine`.
  2. Дуга изгиба – `IfcCircularArcSegment3D` (или `IfcTrimmedCurve` на основе окружности). Параметры: радиус изгиба по ГОСТ (обычно 4–6 диаметров), углы начала и конца.
  3. Верхний прямой участок (от изгиба до резьбового конца) – `IfcLine`.
- **Для типов 2 (исп.1) и 5 (прямые):** только один прямой сегмент – `IfcLine`.

**Алгоритм создания `IfcCompositeCurve`:**
- Создать список сегментов (каждый сегмент – это `IfcCompositeCurveSegment` с соответствующей кривой).
- Указать `SelfIntersect = False`.
- Использовать вспомогательные точки, рассчитанные по длинам и радиусам из ГОСТ.

#### 4.2. Тип шпильки (StudType)

- Создаётся экземпляр `IfcMechanicalFastenerType`.
- Атрибуты:
  - `GlobalId` – генерируется уникальный.
  - `Name` – шаблон: `"Шпилька {позиция}.М{диаметр} х {длина} {марка стали} ГОСТ 24379.1-2012"` (позиция зависит от типа/исполнения).
  - `Description` – можно оставить пустым или указать тип.
  - `ApplicableOccurrence` – ссылка на тип инстанса (необязательно).
  - `HasPropertySets` – список `IfcPropertySet` (см. п.4.5).
- Геометрия:
  - Создаётся `IfcSweptDiskSolid`:
    - `Directrix` – ссылка на созданную `IfcCompositeCurve`.
    - `Radius` – диаметр резьбы / 2.
    - `StartParam`, `EndParam` – можно опустить (весь сегмент).
  - Эта геометрия помещается в `IfcShapeRepresentation` с `RepresentationIdentifier` = "Body", `RepresentationType` = "SweptSolid".
  - `IfcProductDefinitionShape` связывается с типом.

#### 4.3. Профили для гаек и шайб (IfcArbitraryProfileDefWithVoids)

**Гайка (шестигранная):**
- Внешний контур: `IfcPolyline` с шестью вершинами, образующими правильный шестиугольник с размером «под ключ» S.
- Внутреннее отверстие: `IfcCircleProfileDef` с радиусом = диаметр резьбы / 2.
- Профиль: `IfcArbitraryProfileDefWithVoids`:
  - `OuterCurve` – `IfcPolyline`.
  - `InnerCurves` – список из одного `IfcCircleProfileDef`.

**Шайба:**
- Внешний контур: `IfcCircleProfileDef` с радиусом = наружный диаметр шайбы / 2.
- Внутреннее отверстие: `IfcCircleProfileDef` с радиусом = диаметр резьбы / 2.
- Профиль: `IfcArbitraryProfileDefWithVoids` с одним внутренним контуром.

#### 4.4. Типы гаек и шайб

- Создаются аналогично типу шпильки, но с геометрией `IfcExtrudedAreaSolid`.
- Параметры выдавливания:
  - `ExtrudedDirection` – `IfcDirection` (0,0,1).
  - `Depth` – высота гайки / толщина шайбы (берётся из справочника ГОСТ по диаметру).
- Профиль – созданный ранее `IfcArbitraryProfileDefWithVoids`.

#### 4.5. Назначение Property Sets на типах

Для каждого типа создаются соответствующие `IfcPropertySet` и заполняются значениями по умолчанию (например, `NominalDiameter` берётся из параметров). Поскольку типы создаются один раз, они не привязаны к конкретным размерам? Это противоречие: тип должен быть параметрическим, но в IFC тип не может быть изменяемым – он фиксирует геометрию и свойства. Значит, мы должны создавать отдельный тип для каждого типоразмера болта (например, "Шпилька 1.М20х800")? Или использовать один тип с переменными? В IFC тип представляет собой класс объектов с фиксированными атрибутами. Для параметрической генерации нам нужно будет создавать типы «на лету» под каждый введённый пользователем размер. Это нормально, т.к. приложение генерирует модель по запросу, и типы можно создавать динамически. Однако по условию «Этап типизации выполняется один раз» подразумевает, что типы создаются при инициализации приложения и затем используются многократно. Но тогда геометрия типа не может зависеть от входных параметров (диаметра, длины). Следовательно, нужно использовать один тип, геометрия которого строится параметрически на основе данных, передаваемых при создании инстанса? Но в IFC4 тип не может иметь параметрическую геометрию, зависящую от контекста. Значит, правильнее создавать типы динамически для каждого запроса, но кэшировать их, если параметры повторяются. Это компромисс. В плане укажем, что при первом обращении к определённому набору параметров (диаметр, длина, тип болта) создаётся соответствующий тип, который сохраняется в словаре и используется для всех последующих инстансов с такими же параметрами. Это соответствует логике «типизации один раз» для уникальной конфигурации.

Таким образом, в `type_factory.py` реализуется функция `get_or_create_stud_type(diameter, length, bolt_type, execution, material)`, которая возвращает уже существующий или вновь созданный тип шпильки.

#### 4.6. Материалы

- Создаётся `IfcMaterial` с именем, например, "09Г2С".
- Описание: "Сталь 09Г2С по ГОСТ 19281-2014".
- Категория: "STEEL".
- Материал связывается с типом через `IfcRelAssociatesMaterial`.

### 5. Генерация инстансов элементов (размещение в модели)

При получении от пользователя полного набора параметров (тип болта, исполнение, диаметр, длина, марка стали, наличие гаек/шайб) выполняется следующий процесс:

1. **Получение типов**:
   - `stud_type = type_factory.get_or_create_stud_type(...)`
   - `nut_type = type_factory.get_or_create_nut_type(diameter, material)` (гайки и шайбы зависят только от диаметра)
   - `washer_type = type_factory.get_or_create_washer_type(diameter, material)`
   - `assembly_type = type_factory.get_or_create_assembly_type(...)`

2. **Создание инстанса шпильки**:
   - `IfcMechanicalFastener` с `GlobalId`, `Name` (формируется по ГОСТ).
   - `ObjectPlacement` – `IfcLocalPlacement` с размещением в начале координат (или с учётом сборки). Ось Z направлена вдоль шпильки.
   - `Representation` – ссылка на `ProductDefinitionShape` типа (наследуется автоматически через тип, но в IFC инстанс может иметь собственную геометрию? Лучше не назначать, т.к. она уже есть в типе).
   - Отношение `IfcRelDefinesByType` связывает инстанс с `stud_type`.

3. **Создание инстансов гаек и шайб**:
   - Вычисляются координаты размещения:
     - Нижняя шайба и гайка – на определённом расстоянии от нижнего торца (обычно заподлицо или с выступанием).
     - Верхняя шайба и гайка – на выступающем конце шпильки.
   - Для каждого создаётся `IfcMechanicalFastener` с соответствующим `ObjectPlacement` (трансляция и, возможно, поворот вокруг оси Z для гаек, чтобы грани смотрели произвольно).
   - Связь с типом через `IfcRelDefinesByType`.

4. **Создание инстанса сборки**:
   - `IfcMechanicalFastener` с `PredefinedType = ANCHORBOLT`.
   - Размещение совпадает с размещением шпильки.
   - Связь с типом сборки.
   - Агрегация: `IfcRelAggregates` связывает сборку (RelatingObject) со всеми созданными инстансами (RelatedObjects).

5. **Создание соединений**:
   - Для каждой гайки и шайбы создаётся `IfcRelConnectsElements` между шпилькой и соответствующим элементом. Атрибут `ConnectionGeometry` можно опустить.

### 6. Отношения между инстансами

| Тип отношения | Роль | Описание |
|---------------|------|----------|
| `IfcRelDefinesByType` | RelatingType – тип элемента, RelatedObjects – список инстансов | Связывает каждый экземпляр с его типом. |
| `IfcRelAggregates` | RelatingObject – сборка, RelatedObjects – шпилька, гайки, шайбы | Определяет состав конструкции. |
| `IfcRelConnectsElements` | RelatingElement – шпилька, RelatedElement – гайка/шайба | Указывает на физическое соединение. |
| `IfcRelAssociatesMaterial` | RelatingMaterial – материал, RelatedObjects – типы | Привязывает материал ко всем типам. |

### 7. Интеграция с интерфейсом — примеры вызова из JavaScript

В `main.js` инициализируется Pyodide, загружаются Python-модули. При изменении параметров пользователем вызывается асинхронная функция Python:

```javascript
async function generateBolt(params) {
    // params = { boltType: "1.1", diameter: 20, length: 800, steel: "09Г2С", ... }
    const result = await pyodide.runPythonAsync(`
        from instance_factory import create_bolt_assembly
        ifc_data, mesh_data = create_bolt_assembly(${JSON.stringify(params)})
        # ifc_data может быть строкой IFC, mesh_data - сериализованный JSON с геометрией для Three.js
        (ifc_data, mesh_data)
    `);
    // result[0] - IFC-строка, result[1] - меши
    viewer.updateMeshes(result[1]);
    document.getElementById('downloadBtn').onclick = () => downloadIfc(result[0]);
}
```

**Формат mesh_data:**
```json
{
  "meshes": [
    { "vertices": [x1,y1,z1, x2,y2,z2, ...], "indices": [i1,i2,i3, ...], "color": 0xRRGGBB },
    ...
  ]
}
```

### 8. Визуализация — код для 3D-предпросмотра в браузере

**viewer.js:**
- Инициализация Three.js: сцена, камера (PerspectiveCamera), рендерер, освещение (Ambient + Directional).
- Функция `updateMeshes(meshData)`, которая очищает старую геометрию и создаёт новые `BufferGeometry` из переданных вершин и индексов. Меши добавляются на сцену.
- Реализация выбора объекта через Raycaster:
  - При клике мыши испускается луч, определяются пересечённые объекты.
  - Выделение выбранного элемента (изменение цвета, обводка).
  - Отправка события в UI с идентификатором выбранного элемента (например, "stud", "nut_top"), чтобы отобразить свойства.

### 9. Структура данных ГОСТ — примеры справочников

В `gost_data.py` содержатся словари:

```python
# Диаметры резьбы и соответствующие параметры (по ГОСТ 24379.1-2012 и смежным)
BOLT_DIMENSIONS = {
    16: {"thread_pitch": 2.0, "nut_height": 15, "washer_thickness": 3, "washer_outer_diameter": 30, "s_width": 24},
    20: {"thread_pitch": 2.5, "nut_height": 18, "washer_thickness": 4, "washer_outer_diameter": 37, "s_width": 30},
    # ...
}

# Допустимые длины для каждого типа болта (зависят от диаметра)
AVAILABLE_LENGTHS = {
    (1, 1): {16: [400, 500, 630, ...], 20: [500, 630, 800, ...]},
    (1, 2): {16: [400, 500, 630, ...], ...},
    (2, 1): {16: [300, 400, 500, ...], ...},
    (5, None): {16: [300, 400, 500, ...], ...},
}
```

### 10. План реализации — таблица этапов с примерными сроками

| Этап | Задачи | Примерная длительность (чел.-дни) |
|------|--------|-----------------------------------|
| 1 | Настройка инфраструктуры: HTML-страница, подключение Pyodide, Three.js, базовая структура JS-модулей. | 2 |
| 2 | Разработка Python-модулей для работы с IFC (ifc_generator, geometry_utils) – создание низкоуровневых функций для построения кривых, профилей. | 4 |
| 3 | Реализация фабрик типов (type_factory) с кэшированием. Создание геометрии для шпильки, гайки, шайбы в зависимости от параметров. | 5 |
| 4 | Реализация фабрики инстансов (instance_factory): вычисление позиций, создание объектов размещения, отношений. | 3 |
| 5 | Интеграция с интерфейсом: передача параметров из JS в Python, вызов генерации, получение IFC-строки и mesh-данных. | 2 |
| 6 | Визуализация Three.js: создание сцены, добавление мешей, обработка выбора, отображение свойств. | 4 |
| 7 | Разработка UI-панели (HTML/CSS): поля ввода, выпадающие списки, кнопки, панель свойств. | 2 |
| 8 | Наполнение справочников ГОСТ (gost_data.py) для всех типов, исполнений, диаметров, длин. | 2 |
| 9 | Тестирование: проверка генерации IFC на соответствие схеме, валидация геометрии, удобство использования. | 2 |
| 10 | Документирование и финальные правки. | 1 |
| **Итого** | | **27** |

### 11. Итоговая структура IFC-файла — пример фрагмента .ifc

```
ISO-10303-21;
HEADER;...
DATA;
#1=IFCMECHANICALFASTENERTYPE('1pP$...',#2,'StudType.M20x800',$,$,$,$,$,'STUD',.USERDEFINED.);
#2=IFCPROPERTYSET(...);
#3=IFCMATERIAL('09Г2С','Сталь 09Г2С ГОСТ 19281-2014',$);
#4=IFCRELASSOCIATESMATERIAL(...);
#5=IFCSWEPTDISKSOLID(#6,10.,$,$);
#6=IFCCOMPOSITECURVE((#7,#8,#9),.F.);
#7=IFCCOMPOSITECURVESEGMENT(.CONTSAMEGRADIENTSAMECURVATURE.,.T.,#10);
#10=IFCLINE(#11,#12);
...
#20=IFCMECHANICALFASTENER('2N8...',#2,'Шпилька 1.М20х800 09Г2С',$,$,#21,#22,$);
#21=IFCLOCALPLACEMENT(...);
#22=IFCPRODUCTDEFINITIONSHAPE(...); (ссылка на геометрию типа, либо отсутствует, если наследуется)
#23=IFCRELDEFINESBYTYPE('3H...',#2,$,$,$,(#20),#1);
#24=IFCMECHANICALFASTENER('4K...',#2,'Гайка М20',$,$,#25,#26,$);
#25=IFCLOCALPLACEMENT(...);
#26=...;
#27=IFCRELDEFINESBYTYPE(...);
...
#50=IFCMECHANICALFASTENER('5L...',#2,'Болт 1.1.М20х800 09Г2С ГОСТ 24379.1-2012',$,$,#51,$, .ANCHORBOLT.);
#52=IFCRELAGGREGATES('6M...',#2,$,$,#50,(#20,#24,#28,#30,#32));
#60=IFCRELCONNECTSELEMENTS(...);
ENDSEC;
END-ISO-10303-21;
```

### 12. Преимущества архитектуры — таблица преимуществ типо-инстансного подхода

| Преимущество | Пояснение |
|--------------|-----------|
| **Компактность файла** | Геометрия и свойства хранятся один раз на тип, а не дублируются для каждого экземпляра. |
| **Централизованное управление** | Изменение параметров типа (например, материал) автоматически применяется ко всем экземплярам. |
| **Соответствие стандарту IFC** | Модель правильно использует механизмы наследования и отношений, что облегчает взаимодействие с другими IFC-инструментами. |
| **Лёгкость расширения** | Добавление нового типоразмера сводится к созданию нового типа без изменения логики размещения. |
| **Параметрическая генерация** | Типы создаются динамически под конкретные параметры, но кэшируются для повторного использования. |
| **Упрощённый обмен данными** | Можно передавать только идентификаторы типов, если они уже известны в приёмной системе. |
| **Поддержка наследования свойств** | Property Sets, заданные на типе, автоматически наследуются инстансами, что гарантирует наличие всех необходимых атрибутов. |

### Заключение

Предложенный план охватывает все аспекты создания одностраничного приложения: от архитектуры IFC-модели до визуализации и пользовательского интерфейса. Он учитывает требования ГОСТ, особенности работы в браузере с Pyodide и IfcOpenShell, а также обеспечивает высокую производительность за счёт типизации и кэширования. Реализация по данному плану позволит получить надёжный инструмент для проектировщиков и инженеров.