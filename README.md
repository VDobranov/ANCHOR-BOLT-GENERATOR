# ANCHOR-BOLT-GENERATOR

Генератор анкерных болтов (фундаментных болтов) по ГОСТ 24379.1-2012 с экспортом в IFC4 и 3D визуализацией в браузере.

## Обзор

Приложение позволяет:
- ✅ Создавать анкерные болты согласно ГОСТ 24379.1-2012
- ✅ Визуализировать болты в 3D с помощью Three.js
- ✅ Экспортировать результат в файл IFC (Industry Foundation Classes) для BIM
- ✅ Работает полностью в браузере (Python выполняется через Pyodide)
- ✅ Динамическое кэширование типов
- ✅ Полная валидация по ГОСТ
- ✅ Автоматическое определение состава сборки по типу болта
- ✅ Конвертация геометрии через ifcopenshell.geom (единый источник истины)

## Быстрый старт

### Локально

```bash
# 1. Запустить HTTP-сервер
python3 -m http.server 8000

# 2. Открыть в браузере
# http://localhost:8000
```

### Использование

1. Выберите тип болта (1.1, 1.2, 2.1 или 5)
2. Выберите диаметр (М12–М100)
3. Выберите длину (из доступных по ГОСТ)
4. Выберите материал (09Г2С, ВСт3пс2 или 10Г2)
5. Болт генерируется автоматически при изменении параметров
6. Вращайте 3D-вид мышью (ЛКМ — вращение, ПКМ/колесо — панорамирование/зум)
7. Нажмите «Скачать IFC» для экспорта

**Состав сборки определяется автоматически:**
- Типы 1.1, 1.2, 5: шпилька + верхняя шайба + 2 верхних гайки
- Тип 2.1: шпилька + верхняя шайба + 2 верхних гайки + 2 нижних гайки

## Структура проекта

```
anchor-bolt-generator/
├── index.html              # Главная страница
├── style.css               # Стили
├── js/                     # JavaScript модули
│   ├── config.js          # Константы и конфигурация
│   ├── ui.js              # UI утилиты (статусы, toggle, download)
│   ├── form.js            # Управление формой и валидация
│   ├── viewer.js          # 3D визуализация (Three.js)
│   ├── ifcBridge.js       # Мост JS ↔ Python (Pyodide)
│   ├── main.js            # Оркестрация приложения
│   └── init.js            # Точка входа
├── python/                 # Python модули (выполняются в браузере)
│   ├── main.py            # Singleton IFC документа, кэширование ifcopenshell
│   ├── gost_data.py       # Справочники ГОСТ и валидация
│   ├── type_factory.py    # Фабрика и кэширование типов
│   ├── instance_factory.py # Создание инстансов и сборок
│   ├── geometry_builder.py # Построение IFC геометрии (кривые, профили)
│   ├── geometry_converter.py # Конвертация IFC → Three.js mesh (ifcopenshell.geom)
│   ├── material_manager.py # Управление материалами
│   ├── pset_manager.py    # Property Sets
│   ├── ifc_generator.py   # Экспорт IFC
│   └── requirements.txt   # Зависимости Python
├── wheels/                 # Python wheel для Pyodide
│   └── ifcopenshell-*.whl
├── ai/                     # Документация архитектуры
│   └── CONSOLIDATED_PLAN.md
└── README.md
```

## Технические детали

### Архитектура

**Модульная структура:**

| Модуль | Ответственность |
|--------|----------------|
| `config.js` | Константы: URL wheel, список Python-модулей, параметры по умолчанию |
| `ui.js` | UI-утилиты: статусы, переключение элементов, download |
| `form.js` | Класс `BoltForm`: обработка формы, валидация, debouncing |
| `viewer.js` | Класс `IFCViewer`: Three.js сцена, камера, меши, взаимодействие |
| `ifcBridge.js` | Класс `IFCBridge`: загрузка Pyodide, установка ifcopenshell, вызов Python |
| `main.js` | Оркестрация: инициализация, координация модулей |
| `main.py` | Singleton `IFCDocument`: управление IFC файлом, кэширование ifcopenshell |
| `type_factory.py` | Фабрика типов: кэширование `IfcMechanicalFastenerType` |
| `instance_factory.py` | Создание инстансов: размещения, агрегации, mesh-данные |
| `geometry_builder.py` | Построение IFC-геометрии: кривые, профили, выдавливание |
| `geometry_converter.py` | Конвертация IFC → Three.js mesh через ifcopenshell.geom |

**Подход к генерации геометрии:**

Геометрия строится **один раз** в IFC-модели через `type_factory.py` (IfcSweptDiskSolid, IfcExtrudedAreaSolid), затем конвертируется в mesh для Three.js через `geometry_converter.py` с использованием `ifcopenshell.geom.create_shape()`. Это обеспечивает:
- Единый источник истины для геометрии
- Отсутствие дублирования кода
- Корректное соответствие 3D-вида и IFC-данных
- Fallback на ручную генерацию при недоступности ifcopenshell.geom

**Двухэтапная инициализация:**

1. **При загрузке** (один раз):
   - Загрузка Pyodide (~80 МБ)
   - Установка зависимостей: `typing_extensions` → `numpy` → `ifcopenshell`
   - Проверка доступности ifcopenshell.geom
   - Загрузка Python-модулей в виртуальную ФС
   - Создание базовой IFC-структуры (Project → Site → Building → Storey)

2. **При генерации** (каждый запрос):
   - Валидация параметров через `gost_data.py`
   - Автоматическое определение состава сборки по типу болта
   - Получение или создание типов (кэширование)
   - Создание инстансов с размещениями
   - Конвертация IFC-геометрии в mesh через ifcopenshell.geom
   - Обновление 3D-сцены

### IFC-иерархия

```
IfcProject
└── IfcSite
    └── IfcBuilding
        └── IfcBuildingStorey
            └── IfcMechanicalFastener (Assembly: ANCHORBOLT)
                ├── IfcMechanicalFastener (Stud: USERDEFINED)
                ├── IfcMechanicalFastener (Nut #1: USERDEFINED) [опц.]
                ├── IfcMechanicalFastener (Washer #1: USERDEFINED) [опц.]
                ├── IfcMechanicalFastener (Nut #2: USERDEFINED) [опц.]
                └── IfcMechanicalFastener (Washer #2: USERDEFINED) [опц.]
```

**Кэширование типов:**
- Ключ: `(тип, диаметр, длина, исполнение, материал)`
- Один раз созданный тип переиспользуется
- Оптимизирует размер IFC-файла и производительность

### GOST-справочники

**Поддерживаемые типы болтов:**

| Тип | Категория | Форма | Исполнения | Диаметры | Длины |
|-----|----------|-------|-----------|---------|-------|
| 1.1 | I | Изогнутый | 1, 2 | М12–М100 | 400–1600 |
| 1.2 | I | Изогнутый | 1, 2 | М12–М100 | 400–1000 |
| 2.1 | II | Прямой | 1 | М12–М100 | 500–1250 |
| 5 | — | Футорка | 1 | М12–М100 | 500–1000 |

**Доступные диаметры:**  
М12, М16, М20, М24, М30, М36, М42, М48, М56, М64, М72, М80, М90, М100 (14 вариантов)

**Материалы (ГОСТ):**
- **09Г2С** (ГОСТ 19281-2014) — σ_в = 490 МПа, низколегированная сталь
- **ВСт3пс2** (ГОСТ 535-88) — σ_в = 345 МПа, углеродистая конструкционная сталь
- **10Г2** (ГОСТ 19281-2014) — σ_в = 490 МПа, низколегированная сталь

## Технологии

| Компонент | Версия | Назначение |
|-----------|--------|-----------|
| HTML/CSS/JS | HTML5 | Frontend |
| Three.js | r128 | 3D-визуализация |
| Pyodide | 0.26.0 | Python runtime в браузере |
| IfcOpenShell | 0.8.4 | Работа с IFC |
| IFC Standard | IFC4 ADD2 TC1 | Формат файлов |
| Python | 3.13 | Логика IFC |

## API

### JavaScript

```javascript
// Инициализация (автоматически при загрузке)
const bridge = await initializeIFCBridge(pyodide);

// Генерация болта
const result = await bridge.generateBolt({
    bolt_type: '1.1',
    execution: 1,
    diameter: 20,
    length: 800,
    material: '09Г2С',
    has_bottom_nut: false,
    has_top_nut1: true,
    has_top_nut2: true,
    has_washers: true
});

// result.ifcData — IFC-строка для скачивания
// result.meshData — данные для 3D-визуализации
```

### Python

```python
# Инициализация
from main import initialize_base_document, get_ifc_document
ifc_doc = initialize_base_document()

# Генерация болта
from instance_factory import generate_bolt_assembly
ifc_str, mesh_data = generate_bolt_assembly({
    'bolt_type': '1.1',
    'execution': 1,
    'diameter': 20,
    'length': 800,
    'material': '09Г2С'
})

# Конвертация IFC геометрии в Three.js mesh
from geometry_converter import convert_assembly_to_meshes
mesh_data = convert_assembly_to_meshes(ifc_doc, components, color_map)
```

## Примеры

### Пример 1: Простая шпилька

```
Тип: 1.1, Исполнение: 1
Диаметр: М20, Длина: 800 мм
Материал: 09Г2С
Состав: шпилька + шайба + 2 гайки (автоматически)
```

### Пример 2: Полная сборка типа 2.1

```
Тип: 2.1, Исполнение: 1
Диаметр: М24, Длина: 1000 мм
Материал: 10Г2
Состав: шпилька + шайба + 2 верхних гайки + 2 нижних гайки (автоматически)
```

### Пример 3: Экспорт в IFC

```
Тип: 1.1, Исполнение: 1
Диаметр: М20, Длина: 500 мм
Материал: 09Г2С
Файл: bolt_1.1_M20x500.ifc
```

## Статус разработки

| Этап | Статус | Описание |
|------|--------|---------|
| 1. Инфраструктура | ✅ Готово | HTML, CSS, JS основа, Pyodide |
| 2. GOST-справочники | ✅ Готово | gost_data.py с полными таблицами |
| 3. Geometry Builder | ✅ Готово | Построение кривых и профилей |
| 4. Type Factory | ✅ Готово | Кэширование типов |
| 5. Materials & PSets | ✅ Готово | Материалы и свойства |
| 6. Instance Factory | ✅ Готово | Создание инстансов и сборка |
| 7. IFC Generator | ✅ Готово | Экспорт в IFC |
| 8. Интеграция | ✅ Готово | Полная JS/Python интеграция |
| 9. Рефакторинг | ✅ Готово | Модульная архитектура (config, ui, form) |
| 10. ifcopenshell.geom | ✅ Готово | Конвертация IFC → Three.js mesh |
| 11. Геометрия сборок | ✅ Готово | Исправлена геометрия шпилек и шайб |
| 12. Тестирование | ⏳ Планируется | Валидация IFC, примеры |

## Известные ограничения

1. **Pyodide-совместимость** — некоторые сложные IFC-примитивы требуют упрощения
2. **Производительность** — первая загрузка Pyodide занимает 2–3 сек
3. **Браузер** — требуется современный браузер с поддержкой WebGL
4. **Память** — большие сборки могут потребовать больше памяти

## Развитие

Планируемые функции:
- [ ] Добавить все остальные типы болтов из ГОСТ
- [ ] Поддержка импорта параметров из CSV/JSON
- [ ] Пакетная генерация болтов
- [ ] Экспорт в другие форматы (STEP, STL)
- [ ] Совместимость с BIM-приложениями (Revit, ArchiCAD)
- [ ] Настройка размеров гаек/шайб
- [ ] История генерации

## Лицензия

MIT

## Дополнительные ресурсы

- **ГОСТ 24379.1-2012** — Болты фундаментные. Конструкция и размеры
- **ГОСТ 19281-2014** — Прокат повышенной прочности. Общие технические условия
- **IFC4 ADD2 TC1** — Industry Foundation Classes 4.0.2.1 (Version 4.0 - Addendum 2 - Technical Corrigendum 1) [Документация](https://standards.buildingsmart.org/IFC/RELEASE/IFC4/ADD2_TC1/HTML/)
- [Three.js Documentation](https://threejs.org/docs/)
- [Pyodide Documentation](https://pyodide.org/)

## Контакты

Разработано с помощью AI-ассистентов (Claude, Qwen)
