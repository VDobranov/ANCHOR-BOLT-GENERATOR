# ANCHOR-BOLT-GENERATOR — Контекст проекта

## Обзор проекта

**Генератор анкерных болтов** — браузерное приложение для создания фундаментных болтов по **ГОСТ 24379.1-2012** с экспортом в **IFC4 ADD2 TC1** и **3D-визуализацией** через Three.js.

### Основные возможности
- ✅ Создание анкерных болтов по ГОСТ 24379.1-2012
- ✅ 3D-визуализация в браузере через Three.js (ортографическая камера)
- ✅ Экспорт в IFC (Industry Foundation Classes) для BIM-процессов
- ✅ Работа полностью в браузере (Python через Pyodide WebAssembly)
- ✅ Динамическое кэширование типов для оптимизации размера IFC
- ✅ Полная валидация параметров по ГОСТ
- ✅ Автоматическое определение состава сборки по типу болта
- ✅ Конвертация геометрии через `ifcopenshell.geom` (единый источник истины)

### Поддерживаемые типы болтов

| Тип | Категория | Форма | Исполнения | Диаметры | Длины |
|-----|-----------|-------|------------|----------|-------|
| 1.1 | I | Изогнутый | 1, 2 | М12–М48 | 300–1400 |
| 1.2 | I | Изогнутый | 1, 2 | М12–М48 | 300–1000 |
| 2.1 | II | Прямой | 1 | М16–М48 | 500–1250 |
| 5 | — | Футорка | 1 | М12–М48 | 300–1000 |

### Состав сборки (автоматически)
- **Типы 1.1, 1.2, 5**: шпилька + верхняя шайба + 2 верхних гайки
- **Тип 2.1**: шпилька + верхняя шайба + 2 верхних гайки + 2 нижних гайки

---

## Структура проекта

```
ANCHOR-BOLT-GENERATOR/
├── index.html              # Главная HTML-страница (русский UI)
├── style.css               # Стили приложения
├── README.md               # Пользовательская документация (русский)
├── QWEN.md                 # Контекст для AI-ассистентов (этот файл)
├── LICENSE                 # Лицензия MIT
│
├── js/                     # JavaScript модули (5 файлов)
│   ├── config.js           # Константы приложения, URL, значения по умолчанию
│   ├── ui.js               # UI-утилиты (статусы, переключение, скачивание)
│   ├── form.js             # Класс BoltForm: обработка формы, валидация
│   ├── viewer.js           # Класс IFCViewer: сцена Three.js, меши
│   ├── ifcBridge.js        # Класс IFCBridge: мост JS ↔ Python (Pyodide)
│   ├── main.js             # Оркестрация приложения, инициализация
│   └── init.js             # Точка входа
│
├── python/                 # Python модули (8 файлов, среда Pyodide)
│   ├── main.py             # Singleton IFCDocument, базовая структура
│   ├── utils.py            # Централизованный импорт ifcopenshell
│   ├── gost_data.py        # Справочники ГОСТ, валидация, таблицы размеров
│   ├── type_factory.py     # TypeFactory: кэширование IfcMechanicalFastenerType
│   ├── instance_factory.py # InstanceFactory: создание инстансов, сборок
│   ├── geometry_builder.py # Геометрия IFC: кривые, профили, выдавливание
│   ├── geometry_converter.py # Конвертация IFC → mesh Three.js через ifcopenshell.geom
│   └── ifc_generator.py    # Экспорт IFC, валидация документа
│
├── data/
│   └── dim.csv             # Исходные данные размеров болтов
│
├── wheels/
│   └── ifcopenshell-0.8.4+158fe92-cp313-cp313-pyodide_2025_0_wasm32.whl
│
├── assets/
│   ├── favicon.svg
│   └── icons/
│
├── ai/                     # Документация архитектуры от AI
│   ├── CONSOLIDATED_PLAN.md
│   ├── IMPLEMENTATION_SUMMARY.md
│   ├── PLAN_claude.md
│   ├── PLAN_deepseek.md
│   ├── PLAN_qwen.md
│   ├── entry_prompt.md
│   └── Qwen_session_*.md   # Резюме сессий
│
└── .gitignore
```

---

## Технологический стек

| Компонент | Версия | Назначение |
|-----------|--------|------------|
| **Frontend** | HTML5, CSS3, Vanilla JS | Браузерный UI |
| **3D-движок** | Three.js r128 | WebGL-визуализация |
| **Python-среда** | Pyodide 0.26.0 | Python WebAssembly |
| **IFC-библиотека** | IfcOpenShell 0.8.4 | Создание/конвертация IFC |
| **IFC-стандарт** | IFC4 ADD2 TC1 | Российский BIM-стандарт |
| **Материалы** | ГОСТ 19281-2014, ГОСТ 535-88 | Марки стали |

### Доступные материалы
- **09Г2С** (ГОСТ 19281-2014) — σ_в = 490 МПа, низколегированная сталь
- **ВСт3пс2** (ГОСТ 535-88) — σ_в = 345 МПа, углеродистая конструкционная сталь
- **10Г2** (ГОСТ 19281-2014) — σ_в = 490 МПа, низколегированная сталь

---

## Сборка и запуск

### Локальная разработка
```bash
# Запустить HTTP-сервер (Python 3)
python3 -m http.server 8000

# Открыть в браузере
# http://localhost:8000
```

### Сборка не требуется
Приложение работает напрямую в браузере. Pyodide загружает Python-модули динамически во время выполнения.

### Двухэтапная инициализация

**Этап 1: Загрузка приложения (один раз)**
1. Загрузка Pyodide (~80 МБ)
2. Установка зависимостей: `typing_extensions` → `numpy` → `ifcopenshell`
3. Проверка доступности `ifcopenshell.geom`
4. Загрузка Python-модулей в виртуальную файловую систему
5. Создание базовой IFC-структуры (Проект → Участок → Здание → Этаж)

**Этап 2: Генерация болта (каждый запрос)**
1. Валидация параметров через `gost_data.py`
2. Получение/создание типов с кэшированием (TypeFactory)
3. Создание инстансов с размещениями (InstanceFactory)
4. Конвертация IFC-геометрии в mesh через `ifcopenshell.geom.create_shape()`
5. Обновление 3D-сцены

---

## Архитектура

### IFC-иерархия
```
IfcProject
└── IfcSite
    └── IfcBuilding
        └── IfcBuildingStorey
            └── IfcMechanicalFastener (Сборка: ANCHORBOLT)
                ├── IfcMechanicalFastener (Шпилька: USERDEFINED)
                ├── IfcMechanicalFastener (Гайка #1: USERDEFINED) [опц.]
                ├── IfcMechanicalFastener (Шайба #1: USERDEFINED) [опц.]
                ├── IfcMechanicalFastener (Гайка #2: USERDEFINED) [опц.]
                └── IfcMechanicalFastener (Шайба #2: USERDEFINED) [опц.]
```

### Ответственность модулей

#### JavaScript-слой
| Модуль | Ответственность |
|--------|-----------------|
| `config.js` | Константы: URL wheel-пакетов, список Python-модулей, значения по умолчанию |
| `ui.js` | UI-утилиты: статусные сообщения, переключение элементов, скачивание |
| `form.js` | Класс `BoltForm`: обработка формы, валидация, debouncing |
| `viewer.js` | Класс `IFCViewer`: сцена Three.js, камера, меши, взаимодействие |
| `ifcBridge.js` | Класс `IFCBridge`: загрузка Pyodide, настройка ifcopenshell, вызовы Python |
| `main.js` | Оркестрация: инициализация, координация модулей |
| `init.js` | Точка входа приложения |

#### Python-слой
| Модуль | Ответственность |
|--------|-----------------|
| `main.py` | Singleton `IFCDocument`: жизненный цикл IFC-файла, базовая структура |
| `utils.py` | Централизованный импорт `ifcopenshell` (`get_ifcopenshell`) |
| `gost_data.py` | Словари ГОСТ, валидация параметров, таблицы размеров |
| `type_factory.py` | `TypeFactory`: кэширование `IfcMechanicalFastenerType` по ключу `(тип, диаметр, длина, исполнение, материал)` |
| `instance_factory.py` | `InstanceFactory`: создание инстансов, размещений, агрегаций, данных mesh через `ifcopenshell.geom` |
| `geometry_builder.py` | Построение IFC-геометрии: `IfcSweptDiskSolid`, `IfcExtrudedAreaSolid`, кривые, профили |
| `geometry_converter.py` | Конвертация IFC → mesh Three.js через `ifcopenshell.geom.create_shape()` |
| `ifc_generator.py` | Экспорт IFC-файла, валидация документа |

### Подход к геометрии
Геометрия строится **один раз** в IFC-модели через `type_factory.py` с использованием `IfcSweptDiskSolid` и `IfcExtrudedAreaSolid`, затем конвертируется в меши Three.js через `geometry_converter.py` с помощью `ifcopenshell.geom.create_shape()`. Это обеспечивает:
- Единый источник истины для геометрии
- Отсутствие дублирования кода
- Корректное соответствие 3D-вида и IFC-данных

---

## Ключевые API

### JavaScript API
```javascript
// Инициализация (автоматически при загрузке)
const bridge = await initializeIFCBridge(pyodide);

// Генерация болта
const result = await bridge.generateBolt({
    bolt_type: '1.1',
    execution: 1,
    diameter: 20,
    length: 800,
    material: '09Г2С'
});

// result.ifcData — IFC-строка для скачивания
// result.meshData — данные для 3D-визуализации
```

### Python API
```python
# Инициализация
from main import initialize_base_document, get_ifc_document
ifc_doc = initialize_base_document()

# Генерация болта
from instance_factory import generate_bolt_assembly
ifc_str, mesh_data = generate_bolt_assembly({
    'bolt_type': '1.1',
    'execution': 1,
    'diameter': 20,
    'length': 800,
    'material': '09Г2С'
})
```

---

## Конвенции разработки

### Стиль кода
- **JavaScript**: ES6+ модули, классы, async/await
- **Python**: Python 3.13 (Pyodide), type hints где уместно
- **Именование**: английский для кода, русский для UI-строк и комментариев

### Практики тестирования
- Ручное тестирование через браузерный UI
- Валидация IFC в BIM-инструментах (Revit, ArchiCAD, BonsaiBIM)
- Документирование сессий в папке `ai/`

### Руководство по внесению изменений
- Соблюдать соответствие ГОСТ для всех размеров
- Сохранять русский язык UI (пользовательский интерфейс)
- Использовать английский для кода, комментариев и документации
- Документировать архитектурные решения в папке `ai/`

---

## Известные ограничения

1. **Совместимость Pyodide** — некоторые сложные IFC-примитивы требуют упрощения
2. **Производительность** — первая загрузка Pyodide занимает 2–3 секунды
3. **Браузер** — требуется современный браузер с поддержкой WebGL
4. **Память** — большие сборки могут требовать больше памяти
5. **Диапазон диаметров** — ограничено М12–М48 (по источнику DIM.py/BlenderBIM)

---

## Форматы файлов

### Формат IFC-вывода
- **Стандарт**: IFC4 ADD2 TC1 (российский BIM-стандарт)
- **Структура**: Проект → Участок → Здание → Этаж → Крепёж
- **Сущности**: `IfcMechanicalFastener`, `IfcMechanicalFastenerType`, `IfcMaterial`, `IfcPropertySet`

### Входные данные
- **dim.csv**: таблицы размеров болтов (источник: DIM.py/BlenderBIM)
- **gost_data.py**: встроенные словари ГОСТ и правила валидации

---

## Типовые операции

### Генерация болта
1. Выберите тип болта (1.1, 1.2, 2.1 или 5)
2. Выберите диаметр (М12–М48)
3. Выберите длину (по доступным ГОСТ)
4. Выберите материал (09Г2С, ВСт3пс2 или 10Г2)
5. Болт генерируется автоматически при изменении параметров
6. Вращайте 3D-вид мышью (ЛКМ — вращение, колесо — зум, ПКМ — панорамирование)
7. Нажмите «Скачать IFC» для экспорта

### Экспорт IFC-файла
- Формат имени: `bolt_{тип}_М{диаметр}x{длина}.ifc`
- Пример: `bolt_1.1_М20x800.ifc`

---

## Применимые стандарты

- **ГОСТ 24379.1-2012** — Болты фундаментные. Конструкция и размеры
- **ГОСТ 19281-2014** — Прокат повышенной прочности. Общие технические условия
- **ГОСТ 535-88** — Сталь углеродистая обыкновенного качества
- **IFC4 ADD2 TC1** — Industry Foundation Classes 4.0.2.1

---

## Внешние ресурсы

- [ГОСТ 24379.1-2012 PDF](https://files.stroyinf.ru/Data2/1/4293785/4293785690.pdf)
- [Спецификация IFC4 ADD2 TC1](https://standards.buildingsmart.org/IFC/RELEASE/IFC4/ADD2_TC1/HTML/)
- [Документация Three.js](https://threejs.org/docs/)
- [Документация Pyodide](https://pyodide.org/)
- [Документация IfcOpenShell](http://ifcopenshell.org/)

---

## Контекст сессии для AI-ассистентов

При работе с этим проектом:
1. **Сохраняйте соответствие ГОСТ** — все размеры должны соответствовать ГОСТ 24379.1-2012
2. **Сохраняйте русский UI** — пользовательские строки остаются на русском
3. **Код на английском** — переменные, функции, комментарии на английском
4. **Уважайте архитектуру модулей** — 8 Python-модулей, 7 JS-модулей
5. **Используйте ifcopenshell.geom** — единый источник истины для геометрии
6. **Кэшируйте типы** — избегайте дублирования `IfcMechanicalFastenerType`
7. **Тестируйте в браузере** — изменения должны работать в среде Pyodide

---

## История недавнего рефакторинга

### Рефакторинг (22.02.2026)
- Удалён fallback mesh код (~340 строк) — используется только `ifcopenshell.geom`
- Удалены неиспользуемые модули: `material_manager.py`, `pset_manager.py`, `requirements.txt`
- Создан `utils.py` для централизации импорта `ifcopenshell`
- Удалено дублирование `BOLT_DIMENSIONS_SPEC` и `get_bolt_spec` в `gost_data.py`
- Обновлены `config.js` и `ui.js` (удалены несуществующие элементы)
- **Итого:** удалено ~620 строк, добавлено ~80 строк

### Рефакторинг (01.03.2026)
- Удалены неиспользуемые функции в `geometry_builder.py`:
  - `create_hexagon_profile()` — геометрия гайки создаётся в `type_factory.py`
  - `create_washer_profile()` — геометрия шайбы создаётся в `type_factory.py`
  - `create_extruded_solid()` — используется только в удалённых функциях выше
  - `create_placement()` — есть аналог в `instance_factory.py`
  - `create_stud_representation()`, `create_nut_representation()`, `create_washer_representation()` — convenience-функции не использовались
- **Итого:** удалено ~110 строк

### Рефакторинг геометрии (01.03.2026)
- Вся логика построения геометрии перемещена из `type_factory.py` в `geometry_builder.py`:
  - `_create_stud_geometry()` → `create_bent_stud_solid()`, `create_straight_stud_solid()`
  - `_create_nut_geometry()` → `create_nut_solid()`
  - `_create_washer_geometry()` → `create_washer_solid()`
  - `_get_context()` → `GeometryBuilder._get_context()`
  - `_associate_representation()` → `associate_representation()`
- `TypeFactory` теперь отвечает только за кэширование типов
- `GeometryBuilder` содержит всю логику построения IFC-геометрии
- **Итого:** `type_factory.py` сокращён со 286 до 112 строк (~174 строки перемещено)

---

## Текущий статус разработки

| Этап | Статус | Описание |
|------|--------|----------|
| 1. Инфраструктура | ✅ Готово | HTML, CSS, JS основа, Pyodide |
| 2. GOST-справочники | ✅ Готово | `gost_data.py` с полными таблицами |
| 3. Geometry Builder | ✅ Готово | Кривые и профили |
| 4. Type Factory | ✅ Готово | Кэширование типов |
| 5. Материалы и PSets | ✅ Готово | Материалы и свойства |
| 6. Instance Factory | ✅ Готово | Создание инстансов и сборок |
| 7. IFC Generator | ✅ Готово | Экспорт IFC |
| 8. Интеграция | ✅ Готово | Полная JS/Python интеграция |
| 9. Рефакторинг | ✅ Готово | Модульная архитектура |
| 10. ifcopenshell.geom | ✅ Готово | Конвертация IFC → mesh Three.js |
| 11. Геометрия сборок | ✅ Готово | Исправлена геометрия шпилек и шайб |
| 12. Очистка кода | ✅ Готово | Удаление мёртвого кода, централизация импортов |
| 13. Тестирование | ⏳ Планируется | Валидация IFC, примеры |

---

## Быстрая справка

### Параметры болта по умолчанию
```javascript
{
    bolt_type: '1.1',
    execution: 1,
    diameter: 20,
    length: 800,
    material: '09Г2С'
}
```

### Доступные диаметры
М12, М16, М20, М24, М30, М36, М42, М48

### Цвета компонентов (Three.js)
- Шпилька: `0x8B8B8B` (серый)
- Шайба: `0xA9A9A9` (тёмно-серый)
- Гайка: `0x696969` (тускло-серый)
- Сборка: `0x4F4F4F` (тёмный грифель)
